<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Progress QA Viewer</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script defer src="/static/app.js"></script>
  <script>
    window.calendarData = {{ calendar_data|tojson }};
  </script>
  <meta name="color-scheme" content="light dark">
  <style>
    /* Optional: prefer SF font on Apple devices */
    @supports (font: -apple-system-body) {
      html { font: -apple-system-body; }
    }
  </style>
  </head>
<body>
  <header class="container">
    <h1>Прогресс подготовки (QA)</h1>
    <p class="subtitle">Минималистичный трекер в стиле Apple</p>
  </header>

  <main class="container-wide">
  <div class="layout-row">
    <aside class="daily-sidebar-top">
      <section class="daily-progress card">
        <h3>Дневная цель</h3>
        <div class="circular-progress-container">
          <svg class="circular-progress" width="120" height="120" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="50" stroke="var(--border)" stroke-width="8" fill="none"></circle>
            <circle cx="60" cy="60" r="50" stroke="var(--accent)" stroke-width="8" fill="none"
                    stroke-dasharray="314.16" stroke-dashoffset="{{ 314.16 - (daily_pct / 100 * 314.16) }}"
                    stroke-linecap="round" transform="rotate(-90 60 60)" class="progress-circle"></circle>
          </svg>
          <div class="progress-text">
            <div class="progress-number">{{ today_progress }}/{{ daily_goal }}</div>
            <div class="progress-label">вопросов</div>
          </div>
        </div>
      </section>

      <section class="activity-calendar card">
        <h3>Активность</h3>
        <div id="calendar" class="calendar-grid"></div>
      </section>
    </aside>

    <main class="main-layout">
      <div class="main-content card">
      <section class="progress">
        <div class="controls">
          <form action="{{ url_for('set_total') }}" method="post" class="inline-form">
            <label for="total">Всего вопросов:</label>
            <input type="number" min="0" id="total" name="total" value="{{ total }}" required>
            <button type="submit">Обновить</button>
          </form>

          <form action="{{ url_for('add') }}" method="post">
            <button type="submit" class="primary">+1 вопрос закрыт</button>
          </form>

          <button id="resetBtn" class="reset">Сбросить прогресс</button>
        </div>

        <div class="progress-header">
           <div><strong>{{ completed }}</strong> из <strong>{{ total }}</strong></div>
           <div>{{ '%.1f' % pct }}%</div>
         </div>
         <div class="milestones">
           {% for m in milestones %}
             <span class="milestone-badge {% if m in achieved_milestones %}achieved{% endif %}" data-milestone="{{ m }}">{{ m }}%</span>
           {% endfor %}
         </div>
        <div class="progress-bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ '%.1f' % pct }}">
          <div class="progress-fill" style="width: {{ pct }}%"></div>
        </div>
        <div class="progress-footer">
          <span>Осталось: <strong>{{ remaining }}</strong></span>
          {% if eta_iso %}
            <span>ETA: <strong>{{ eta_iso.split('T')[0] }}</strong></span>
          {% else %}
            <span>ETA: —</span>
          {% endif %}
          <span>Скорость: <strong>{{ rate_per_day }}</strong>/день</span>
        </div>
      </section>

      {% if completed > 0 %}
      <section class="chart">
        <div class="chart-controls">
          <button id="fullChartBtn" class="chart-toggle active">Полный прогноз</button>
          <button id="currentChartBtn" class="chart-toggle">Текущий прогресс</button>
        </div>
        <div class="chart-area">
          <canvas id="progressChart"></canvas>
        </div>
      </section>
      {% endif %}
      </div>
    </main>
  </div>
  </main>

  <footer class="container footer">
    <small>Совет: делай по одному шагу. Видимый прогресс мотивирует.</small>
  </footer>
</body>
</html>
